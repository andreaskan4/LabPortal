@page "/login"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@using LabPortal.Client.Providers
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using System.Text.Json.Serialization;

<h3>Είσοδος Χρήστη</h3>

<div style="max-width: 400px; margin: auto;">

    <div class="mb-3">
        <label>Email</label>
        <input @bind="loginModel.Email" class="form-control" placeholder="user@example.com" />
    </div>
    <div class="mb-3">
        <label>Password</label>
        <input @bind="loginModel.Password" type="password" class="form-control" />
    </div>

    <button class="btn btn-success w-100" @onclick="HandleLogin">Σύνδεση</button>

    <div class="text-center my-3">
        <span class="text-muted">--- Ή ---</span>
    </div>

    <div id="google-btn"></div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-2">@errorMessage</div>
    }

    <div class="mt-3 text-center">
        <small>Δεν έχεις λογαριασμό; <a href="register">Εγγραφή εδώ</a></small>
    </div>
</div>

@code {
    private LoginDto loginModel = new LoginDto();
    private string errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var clientId = "556583745456-5f8tch4j4329g11qvqce67srbiklvi2v.apps.googleusercontent.com";

                await JS.InvokeVoidAsync("initializeGoogleSignIn", clientId, DotNetObjectReference.Create(this));
            }
            catch (Exception ex)
            {
                Console.WriteLine("Google Init Error: " + ex.Message);
            }
        }
    }

    [JSInvokable]
    public async Task HandleGoogleLogin(string googleIdToken)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/account/google-login", new { IdToken = googleIdToken });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsAuthenticated(result.AccessToken);
                Navigation.NavigateTo("/chat");
            }
            else
            {
                errorMessage = "Αποτυχία σύνδεσης με Google.";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Σφάλμα: " + ex.Message;
            StateHasChanged();
        }
    }

    private async Task HandleLogin()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/account/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsAuthenticated(result.AccessToken);
                Navigation.NavigateTo("/chat");
            }
            else
            {
                errorMessage = "Λάθος email ή κωδικός!";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Σφάλμα σύνδεσης: " + ex.Message;
        }
    }

    public class LoginDto { public string Email { get; set; } public string Password { get; set; } }

    public class LoginResponse
    {
        [JsonPropertyName("accessToken")]
        public string AccessToken { get; set; } = "";
    }
}